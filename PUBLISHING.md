# Publishing Guide

This document explains how to publish **barrel-loader** to npm.

## Prerequisites

Before publishing, ensure:
1. All tests pass: `cargo test` (Rust) and `node test.cjs` (integration)
2. Build succeeds: `pnpm build` (both Rust and TypeScript)
3. Code is formatted and linted: Biome checks pass
4. Both version numbers are updated (see Version Sync)
5. Changes are committed and pushed to main

### Pre-publish Checklist

```bash
# Run full test suite
cargo test

# Run integration tests
node test.cjs

# Build (Rust + TypeScript)
pnpm build

# Verify linting and formatting
npx @biomejs/biome check

# Verify package contents
npm pack --dry-run
```

## Version Sync

**IMPORTANT**: Update version in BOTH files to match:

1. **Cargo.toml**:
   ```toml
   [package]
   version = "0.1.6"  # Update this
   ```

2. **package.json**:
   ```json
   {
     "version": "0.1.6"  // Must match Cargo.toml
   }
   ```

Version mismatch will cause confusion and potential issues with native module loading.

## Publishing to npm

### Setup (One-time)

1. Create npm account at [npmjs.com](https://npmjs.com)
2. Generate an access token with publish permissions
3. Login locally: `npm login`

### Manual Publishing

```bash
# Verify you're on main branch and all changes committed
git status

# Build fresh release
pnpm build

# Verify build output
ls -la dist/
ls -la native/

# Publish to npm
npm publish

# Verify publication
npm view barrel-loader
```

### Publishing via GitHub Releases (Recommended)

1. Update `Cargo.toml` and `package.json` with new version (e.g., `0.1.6`)
2. Commit version bump:
   ```bash
   git add Cargo.toml package.json
   git commit -m "chore: bump version to 0.1.6"
   git push
   ```
3. Create GitHub release with tag `v0.1.6` (matching version)
4. If you have a publish workflow configured, it will automatically build and publish

### Package Configuration

**Package Fields** (in `package.json`):
- `name`: `barrel-loader`
- `version`: Must match Cargo.toml
- `private`: Must be `false` for publishing
- `main`: Points to CommonJS loader (`dist/index.cjs`)
- `exports`: Dual entry point (loader + utilities)
- `native`: Specifies native module location

```json
{
  "name": "barrel-loader",
  "version": "0.1.6",
  "private": false,
  "main": "./dist/index.cjs",
  "exports": {
    ".": {
      "types": "./dist/index.d.cts",
      "require": "./dist/index.cjs"
    },
    "./barrel-loader-utils": {
      "types": "./dist/barrel-loader-utils.d.cts",
      "require": "./dist/barrel-loader-utils.cjs"
    }
  },
  "files": [
    "dist/",
    "native/",
    "README.md",
    "LICENSE"
  ]
}
```

### Native Module Requirements

The package includes a pre-compiled native module at `native/barrel_loader_rs.node`:

- Generated by: `pnpm build:rust` (via `./build.sh`)
- Required for: Webpack/Rspack loader to function
- Platform: Compiled for current system only
- Distribution: Package.json `files` field includes `native/`

**NOTE**: Users on different platforms may need to rebuild. Consider:
- Building on multiple platforms (Linux, macOS, Windows)
- Publishing pre-built binaries for common platforms
- Providing build instructions in README for users on unsupported platforms


## Versioning Strategy

Follow [Semantic Versioning](https://semver.org/):

- **MAJOR** (X.0.0): Breaking changes to API or native module
- **MINOR** (0.X.0): New features, backward compatible
- **PATCH** (0.0.X): Bug fixes only

Examples:
- `0.1.0` → `0.2.0`: New option added to loader
- `0.1.0` → `0.1.6`: Bug fix in parser
- `0.1.0` → `1.0.0`: Webpack loader API changed

## Troubleshooting

### Version Mismatch Error
- **Symptom**: npm warns or native module doesn't match version
- **Solution**: Ensure `Cargo.toml` and `package.json` have identical versions
  ```bash
  grep "version" Cargo.toml package.json
  ```

### Build Fails
- **Symptom**: `pnpm build` fails on your platform
- **Solution**: 
  1. Ensure Rust is installed: `rustc --version`
  2. Ensure Node.js 18+: `node --version`
  3. Clean and rebuild: `pnpm clean && pnpm build`

### "private": true prevents publishing
- **Solution**: Verify `package.json` has `"private": false`

### 403 Forbidden when publishing
- **Symptom**: `npm ERR! 403 Forbidden`
- **Solutions**:
  - Verify npm token is valid: `npm whoami`
  - Check token has publish permissions  
  - If scoped, ensure registry is correct (unscoped here)

### Authentication errors
- **Solution**: `npm login` and provide credentials

### Module not found errors during npm install
- **Symptom**: `native/barrel_loader_rs.node` not found
- **Causes**: 
  - Running on unsupported platform
  - Prebuild not available for platform
  - Native module not published with package
- **Solution**: Rebuild from source or use prebuild action

## Post-publish Verification

```bash
# Wait 1-2 minutes for npm CDN to update
sleep 60

# Check package metadata
npm view barrel-loader version
npm view barrel-loader

# Install from npm in a test directory
mkdir test-barrel
cd test-barrel
npm install barrel-loader
```

## Cross-platform Builds

For production releases, consider building on multiple platforms:

```bash
# macOS (arm64)
pnpm build

# Linux (x64) - via CI or Docker
docker run --rm -v $PWD:/work -w /work node:18 bash -c "pnpm install && pnpm build"

# Windows (x64) - via CI or native Windows machine
pnpm build
```

Publish platform-specific prebuilts using tools like [napi-rs/setup-node](https://github.com/napi-rs/setup-node).

## Release Notes Template

When creating a GitHub release, use this template:

```markdown
## Changes in v0.1.6

### Features
- Added `convertNamespaceToNamed` option to convert `export * as` to named exports

### Bug Fixes
- Fixed parsing of type-only exports with whitespace

### Performance
- Optimized regex compilation for 15% faster parsing

### Breaking Changes
- None

### Dependencies
- Updated regex from 1.9 to 1.10

### Installation
\`\`\`bash
npm install barrel-loader@0.1.6
\`\`\`
```
